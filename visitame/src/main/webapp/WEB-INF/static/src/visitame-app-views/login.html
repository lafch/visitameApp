<link rel="import" href="../../bower_components/polymer/polymer-element.html">
 <link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import"	href="../visitame-app-services/configuracion-service.html">
<link rel="import"	href="../visitame-app-services/customer-service.html">
 <!-- 
<link rel="import" href="../../bower_components/google-recaptcha/google-recaptcha.html">-->
 <link rel="import" href="../../bower_components/paper-input/paper-input.html">
 <link rel="import" href="../../bower_components/paper-input/paper-input-error.html">
 
 <link rel="import" href="../../bower_components/paper-button/paper-button.html">

 <link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
 
 <link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
 <link rel="import" href="../../bower_components/paper-item/paper-item.html">
 <link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
 
 <link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">


 <link rel="import"	href="../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../visitame-app-styles/main-style.html">
<link rel="import" href="../visitame-app-styles/login-style.html">
<link rel="import" href="../visitame-app-icons/main-icons.html">


<dom-module id="login-view"> 

  <template>
   <meta charset="utf-8">
  	<customer-service      id="customerService"></customer-service>
  	<configuracion-service id="configuracionService"></configuracion-service>
  	<meta charset="utf-8">
    <style include="main-styles"></style>
    <style include="login-style"></style>
    
    <paper-spinner class="paper-spinner-loading" id="loadingLista" active></paper-spinner>
	
	<app-header reveals>
	
      <app-toolbar>
	      <paper-icon-button id = "btnRetornarMain" on-click = "retornarMain" class="back-btn-login-main" icon="chevron-left" aria-label="Atrás" ></paper-icon-button>
	      <div main-title>Ticket de atención</div>
      </app-toolbar>
    </app-header>
	
	
	<div class = "content-form" id = "panelForm">
	
	<h3>Reserva tu ticket de atención para:</h3>
	
	<div class = "content-franga-login">
	
	<div class ="up"></div>
	<div class ="bottom"></div>
	
	
	<div class="box-init">

	<div class="left">
		<div class="content">
		<h3>{{data.description}}</h3>
		<p>{{data.address}}</p>
		</div>
	</div>
	
	<div class=right>
	<img src = "{{icon}}" />
	</div>
	
	<div class="usuario-atencion">
		<iron-icon icon="my-icons:person"></iron-icon> <div>Usuario en espera de atención: 11</div>
	</div>
	
	
	</div>
	
	</div>
	<div class="form-reserva">
   <iron-form id="login"> 
      <form method="POST" >
      <div class="content-input-form">
          <paper-dropdown-menu label="Tipo documento" required>
	          <paper-listbox slot="dropdown-content" selected="{{tipoDocumento}}" attr-for-selected="valor">
	            <template is="dom-repeat" items="{{listTipoDoi}}" >
	            	<paper-item valor="{{item.name}}">{{item.name}}</paper-item>
	            </template>
	          </paper-listbox>
          </paper-dropdown-menu>
       </div>
        
          <div class="content-input-form" >
          <paper-input autofocus always-float-label required error-message$="{{mensaje}}" id="inputNumeroDocumento" pattern="[0-9]*"  maxlength$="[[numeroCaracteres]]" max$="[[numeroCaracteres]]" minlength$="[[numeroCaracteres]]"  label="Ingresar numero"  ></paper-input>
          </div>
           <!--  <div id="captcha">
         	 <google-recaptcha id="cap" force-in-body 
			    sitekey="6LdHISEUAAAAAN0FxtC5OBGQv-zrtj1tQ1Z_KUWf"
			    
			  ></google-recaptcha>
			
          </div>-->
          <div id="maincontainer">
          <div class="g-recaptcha" data-sitekey="6LdodhMUAAAAAOVHHUa7ukXl1bKJVwKjGhcA_gVK"></div>
          </div>
          <div class="botonera">
          	<paper-button class="reservar" raised on-click="reservar">Reservar</paper-button>
          	<paper-button raised on-click="cancelar">Cancelar</paper-button>
          </div>
          
          <div class="output"></div>
      </form>
      </iron-form>
      </div>
      </div>
      
      <div id = "panelResultTicket" style="display:none;">
      
      <div class = "headerResultTicket"></div>
      
       <div class = "ticket-body">
       <div class="content">
       
       <h3 class="text-grey-strong" >Hola Juan</h3>
       
       <p class="text1 textAfterTitle" >Tu número de atencion es:</p>
       
       <h2 class="text-celeste textNumTicket">F218</h2>
       
           <p class="textEnAtencion" >En plataforma</p>
    
    <div style="clear: both;"></div>

	<p class="text-fecha-hora-atencion">Fecha y hora de atención: 16/06/2017 - 14:20 hrs</p>
	<p class="text-grey-light">Para poder atenderte, por favor, acércate a la
siguiente oficina y verifica que tu número se
muestre en la pantalla de espera:</p>
<div class = "content-franga-login">
	<div class="box-init">

	<div class="left">
		<div class="content">
		<h3>{{data.description}}</h3>
		<p class="tickectDireccionOficina">{{data.address}}</p>
		</div>
	</div>
	
	<div class=right>
	<img src = "{{icon}}" />
	</div>
	
	<div class="usuario-atencion">
		<iron-icon icon="my-icons:person"></iron-icon> <div>Usuario en espera de atención: 11</div>
	</div>
	
	
	</div>
	
	</div>
       
       <div class="botonera">
          	<paper-button class="reservar" raised on-click="retornarInit">Volver al mapa de oficinas</paper-button>
       </div>
       </div>
       </div>
      </div>
      
  </template>
  <script>
  class LoginView extends Polymer.Element {
      static get is() { return 'login-view'; }
      static get properties(){
          return {

          contextPath:{
              type  : String,
              value : baseUrl
              },    
    	  listTipoDoi : {
              			  type : Array,
              			  value : []
            		    },
          tipoDocumento: {
          	type:String,
          	value:'DNI',
          	observer: '_cambioTipoDocumento'
          },
           numeroCaracteres:{
        	   type:String,
        	   value:'8'
           },
          mensaje: String
          ,
          parentApp : {
				type : Object
              }
          ,
          data:{
       	   type : Object,
       	   value : {}
          }
          ,
          icon : {
			type : String
          }
           
      	 }
      }
		
      setParentApp(parent){
			this.parentApp = parent;
	  }

      getParentApp(){
			return this.parentApp;
	  }

      renderData(data){
        this.returnPanelResult();
		if(data && data.item && data.item.data){
			this.data = data.item.data;
		}else{
			this.data = {};
			return
		}
		if(data && data.icon){
			this.icon = this.contextPath + 'static/' + data.icon
		}

		try{
			grecaptcha.render(this.$.maincontainer.querySelector('.g-recaptcha'), {
			      'sitekey' : '6LfB6SYUAAAAAMjkzbg_4lctIV6nlFR7fsGUCT9p',
			    });
			}catch(e){}
		
      }
      /*mostrarCaptcha(){
    	  this.$.captcha.style.display="block";
      }*/
      ready() {
         super.ready();
                          
         console.log('en el login');
         var configuracionService = this.$.configuracionService;
			 var requestTiposDoi = configuracionService.listarTiposDoi({
					params : {"codigoLista": "PERSON_DOI_TIPO"}
		     });
			 requestTiposDoi.then((xhr) => { 
		    	 this.handleResponse(xhr.response);
		     });
			 
     }

      retornarMain(){
		this.getParentApp().closeLogin();
      }
      
      handleResponse(response) {
          let data = [];
          if(response.valores){
            response.valores.forEach((valor,index)=>{
                data.push(
                  {
                    name : valor.nbEtiqueta
                  }
                );
            });
            this.$.loadingLista.active = false;
            this.listTipoDoi = data;
          
          }
      }
      
      _cambioTipoDocumento(){
    	  if(this.tipoDocumento === "EXT"){
    		  this.numeroCaracteres="11";
    		  
    	  }else{
    		  this.numeroCaracteres="8";
    	  }
    	  
    	  this.$.inputNumeroDocumento.focus();
    	  
    	  
      }

      showPanelResult(){

		 this.$.panelForm.style.display = 'none';
		 this.$.panelResultTicket.style.display = 'block';
    	  
      }

      retornarInit(){
    	  this.cancelar();
    	  setTimeout(()=>{
    		  this.returnPanelResult();
          },100);
    	  
    	 
     }

      returnPanelResult(){
    	 this.$.panelResultTicket.style.display = 'none';
 		 this.$.panelForm.style.display = 'block';
      }
      
      reservar(){
          this.showPanelResult();
/*     	  if(this.$.inputNumeroDocumento.validate()){
    		  var customerService = this.$.customerService;
    		  var numeroDocumento = this.$.inputNumeroDocumento.value;
    			 if("undefined" !== typeof customerService){
    				 var requestEsCliente = customerService._esCliente({
    						params : {
    							"documentNumber": numeroDocumento,
    							"documentType":   this.tipoDocumento
    						}
    			     });
    				 requestEsCliente.then((xhr,fail) => { 
    			    	 this.handleResponse(xhr.response);
    			     },(error) =>{
    			    	 if("undefined" !== typeof error.code){
    			     	  	console.log("error" + error.code); 
    			     	  	switch(error.code) {
    			      	    	case error.PERMISSION_DENIED:
    			      	    		this.errorDescripcion = "Usuario deneg&#243; utilizar la ubicación GPS."
    			        	      break;
    			        	    case error.POSITION_UNAVAILABLE:
    			        	    	this.errorDescripcion = "La información de ubicación es inhabilitada."
    			        	      break;
    			        	    case error.TIMEOUT:
    			        	    	this.errorDescripcion = "La solicitud para obtener la ubicación del usuario se ha agotado."
    			        	      break;
    			        	    case error.UNKNOWN_ERROR:
    			        	    	this.errorDescripcion = "Un error desconocido ocurrió."
    			        	      break;
    			        	}
    			     	 }else{
    			     		var mensaje = new Object();
    			     		mensaje.mensajeError = "Error de servicio";
    			     		mensaje.severidad = "ALTA" ;
    			     		mostrarError(mensaje);
    			     	 }
    					});
//     			     .catch((reason) => {
//     			    	 console.log(reason);
    			    	 
//     			     } );
    			 }  
    		  
    	  }else{
    		  this.mensaje="*Campo obligatorio, ingresar solo numeros.";
    	  } */
    	  
      }
      
      reset(){
    	  this.tipoDocumento = "DNI";
    	  this.$.inputNumeroDocumento.value="";
    	  this.$.inputNumeroDocumento.invalid = false;
      }

      cancelar(){
          
    	  SyncObjects(()=>{
    		  	this.reset();
    	    	this.getParentApp().closeLogin();  
    	  });
      }
      
    }
    window.customElements.define(LoginView.is, LoginView);
  </script>
</dom-module>
