<link rel="import" href="../../bower_components/polymer/polymer-element.html">
 <link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import"	href="../visitame-app-services/configuracion-service.html">
<link rel="import"	href="../visitame-app-services/customer-service.html">
 
 <link rel="import" href="../../bower_components/paper-input/paper-input.html">
 <link rel="import" href="../../bower_components/paper-input/paper-input-error.html">
 
 <link rel="import" href="../../bower_components/paper-button/paper-button.html">

 <link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
 
 <link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
 <link rel="import" href="../../bower_components/paper-item/paper-item.html">
 <link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">


 <link rel="import"	href="../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../visitame-app-styles/main-style.html">

<dom-module id="login-view">
  <template>
  	<customer-service      id="customerService"></customer-service>
  	<configuracion-service id="configuracionService"></configuracion-service>
  	
    <style include="main-styles">
      :host {
        display: block;

        padding: 10px;
      }
      
      paper-dropdown-menu{
      	width: 100%;
      }
      
      paper-listbox{
      	width: 53.5vh;
      }
      
      .botonera{
      	text-align: center;
      	padding-top: 5px;
      }
    </style>
	<paper-spinner class="paper-spinner-loading" id="loadingLista" active></paper-spinner>
   <iron-form id="login"> 
      <form method="get" >
          <paper-dropdown-menu label="Tipo documento" required>
	          <paper-listbox slot="dropdown-content" selected="{{tipoDocumento}}" attr-for-selected="valor">
	            <template is="dom-repeat" items="{{listTipoDoi}}" >
	            	<paper-item valor="{{item.name}}">{{item.name}}</paper-item>
	            </template>
	          </paper-listbox>
          </paper-dropdown-menu>
          
          <paper-input autofocus always-float-label required error-message$="{{mensaje}}" id="inputNumeroDocumento" pattern="[0-9]*"  maxlength$="[[numeroCaracteres]]" max$="[[numeroCaracteres]]" minlength$="[[numeroCaracteres]]"  label="Ingresar numero"  ></paper-input>
          
          <div class="botonera">
          	<paper-button raised on-click="_reservar">Reservar</paper-button>
          	<paper-button raised on-click="_reset">Cancelar</paper-button>
          </div>
          
          <div class="output"></div>
      </form>
      </iron-form>
  </template>

  <script>
    class LoginView extends Polymer.Element {
      static get is() { return 'login-view'; }
      static get properties(){
          return {
    	  listTipoDoi : {
              			  type : Array,
              			  value : []
            		    },
          tipoDocumento: {
          	type:String,
          	value:'DNI',
          	observer: '_cambioTipoDocumento'
          },
           numeroCaracteres:{
        	   type:String,
        	   value:'8'
           },
          mensaje: String
           
      	 }
      }
      ready() {
         super.ready();
         console.log('en el login');
         var configuracionService = this.$.configuracionService;
		 if("undefined" !== typeof configuracionService){
			 var requestTiposDoi = configuracionService.listarTiposDoi({
					params : {"codigoLista": "PERSON_DOI_TIPO"}
		     });
			 requestTiposDoi.then((xhr) => { 
		    	 this.handleResponse(xhr.response);
		     });
		 }
    }
      
      handleResponse(response) {
          let data = [];
          if(response.valores){
            response.valores.forEach((valor,index)=>{
                data.push(
                  {
                    name : valor.nbEtiqueta
                  }
                );
            });
            this.$.loadingLista.active = false;
            this.listTipoDoi = data;
          }
      }
      
      _cambioTipoDocumento(){
    	  if(this.tipoDocumento === "EXT"){
    		  this.numeroCaracteres="11";
    		  
    	  }else{
    		  this.numeroCaracteres="8";
    	  }
    	  
    	  this.$.inputNumeroDocumento.focus();
    	  
    	  
      }
      
      _reservar(){
    	  if(this.$.inputNumeroDocumento.validate()){
    		  var customerService = this.$.customerService;
    		  var numeroDocumento = this.$.inputNumeroDocumento.value;
    			 if("undefined" !== typeof customerService){
    				 var requestEsCliente = customerService._esCliente({
    						params : {
    							"documentNumber": numeroDocumento,
    							"documentType":   this.tipoDocumento
    						}
    			     });
    				 requestEsCliente.then((xhr,fail) => { 
    			    	 this.handleResponse(xhr.response);
    			     },(error) =>{
    			    	 if("undefined" !== typeof error.code){
    			     	  	console.log("error" + error.code); 
    			     	  	switch(error.code) {
    			      	    	case error.PERMISSION_DENIED:
    			      	    		this.errorDescripcion = "Usuario deneg&#243; utilizar la ubicación GPS."
    			        	      break;
    			        	    case error.POSITION_UNAVAILABLE:
    			        	    	this.errorDescripcion = "La información de ubicación es inhabilitada."
    			        	      break;
    			        	    case error.TIMEOUT:
    			        	    	this.errorDescripcion = "La solicitud para obtener la ubicación del usuario se ha agotado."
    			        	      break;
    			        	    case error.UNKNOWN_ERROR:
    			        	    	this.errorDescripcion = "Un error desconocido ocurrió."
    			        	      break;
    			        	}
    			     	 }else{
    			     		var mensaje = new Object();
    			     		mensaje.mensajeError = "Error de servicio";
    			     		mensaje.severidad = "ALTA" ;
    			     		mostrarError(mensaje);
    			     	 }
    					});
//     			     .catch((reason) => {
//     			    	 console.log(reason);
    			    	 
//     			     } );
    			 }  
    		  
    	  }else{
    		  this.mensaje="*Campo obligatorio, ingresar solo numeros.";
    	  }
    	  
      }
      
      _reset(){
    	  this.tipoDocumento = "DNI";
    	  this.$.inputNumeroDocumento.value="";
    	  this.$.inputNumeroDocumento.invalid = false;
      }
      
    }
    

    window.customElements.define(LoginView.is, LoginView);
  </script>
</dom-module>
